#!/bin/bash
set -o errexit
set -o pipefail
set -o nounset

# For backward compatibility, allow both PG* and POSTGRES_* forms,
# with the non-standard POSTGRES_* form taking precedence.
# An error will be raised if neither form is given, except for the PGPORT
export PGDATABASE="${POSTGRES_DB:-${PGDATABASE?}}"
export PGUSER="${POSTGRES_USER:-${PGUSER?}}"
export PGPASSWORD="${POSTGRES_PASSWORD:-${PGPASSWORD?}}"
export PGPORT="${POSTGRES_PORT:-${PGPORT:-5432}}"

# List of postgres servers
# "xxx.xxx.xxx.xxx&host=xxx.xxx.xxx.xxx&host=..."
if [[ -z "${PGHOSTS_LIST}" ]]
then
  export HOST_COUNT=1
  export PGHOSTS="${POSTGRES_HOST:-${PGHOST?}}"
else
  export HOST_COUNT=`awk -F"&" '{print NF}' <<< "${PGHOSTS_LIST}"`
  export PGHOSTS="${PGHOSTS_LIST}"
fi

export NO_GZIP=${NO_GZIP:-1}
if [[ ${NO_GZIP} ]] && [[ ! ${NO_GZIP} == "0" ]] && [[ ! ${NO_GZIP} == "true" ]]
then
  export NO_GZIP=1
fi

export USE_KEY_COLUMN=${USE_KEY_COLUMN:-1}
if [[ ${USE_KEY_COLUMN} ]] && [[ ! ${USE_KEY_COLUMN} == "0" ]] && [[ ! ${USE_KEY_COLUMN} == "true" ]]
then
  export USE_KEY_COLUMN=1
fi

export FUNC_ZXY=${FUNC_ZXY:-getmvt}
export TEST_ON_STARTUP="${TEST_ON_STARTUP:-0}"
export COPY_CONCURRENCY=${COPY_CONCURRENCY:-1}  # number of CPUs per postgres server
export MAX_HOST_CONNECTIONS=${MAX_HOST_CONNECTIONS:-${COPY_CONCURRENCY}}
export ALL_STREAMS=$(( MAX_HOST_CONNECTIONS * HOST_COUNT ))

export EXPORT_DIR=${EXPORT_DIR:-/export}
export MBTILES_FILE=${MBTILES_FILE:-tiles.mbtiles}
export RENDER_SCHEME=${RENDER_SCHEME:-pyramid}
export RETRY=${RETRY:-2}
export BBOX=${BBOX:-"-180.0,-85.0511,180.0,85.0511"}
export TIMEOUT=${TIMEOUT:-1800000}
export MIN_ZOOM=${MIN_ZOOM:-0}
export MAX_ZOOM=${MAX_ZOOM:-14}

export PGQUERY="pgquery://?database=${PGDATABASE}&host=${PGHOST}&port=${PGPORT}&username=${PGUSER}&password=${PGPASSWORD}&funcZXY=${FUNC_ZXY}&testOnStartup=${TEST_ON_STARTUP}&maxpool=${MAX_HOST_CONNECTIONS}&nogzip=${NO_GZIP}&key=${USE_KEY_COLUMN}"
echo $PGQUERY

function export_local_mbtiles() {
	exec tilelive-copy \
        --scheme="$RENDER_SCHEME" \
        --retry="$RETRY" \
        --bounds="$BBOX" \
        --timeout="$TIMEOUT" \
        --minzoom="$MIN_ZOOM" \
        --maxzoom="$MAX_ZOOM" \
        --concurrency="$ALL_STREAMS" \
        "$PGQUERY" \
        "mbtiles://${EXPORT_DIR}/${MBTILES_FILE}"
}

echo "Generating zoom $MIN_ZOOM..$MAX_ZOOM from $HOST_COUNT servers, using $MAX_HOST_CONNECTIONS connections per server, $ALL_STREAMS parallel streams..."
export_local_mbtiles
